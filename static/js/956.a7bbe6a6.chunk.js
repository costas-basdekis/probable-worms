!function(){"use strict";var e={3956:function(e,t,n){var a=n(7762),i=n(5671),r=n(3144),u=n(4165),s=n(9062),o=n(3324),c=n(7675),l="W",h=[1,2,3,4,5,l],v=new Map([[1,1],[2,2],[3,3],[4,4],[5,5],[l,5]]),f=function(){function e(t){(0,i.Z)(this,e),this.counts=void 0,this.key=void 0,this.total=void 0,this.counts=new Map(t),this.key=JSON.stringify(Array.from(this.counts.entries()).sort()),this.total=Array.from(this.counts.entries()).reduce((function(e,t){var n=(0,o.Z)(t,2),a=n[0],i=n[1];return e+v.get(a)*i}),0)}return(0,r.Z)(e,[{key:"adding",value:function(t,n){return new e([].concat((0,s.Z)(Array.from(this.counts.entries())),[[t,n]]))}},{key:"copy",value:function(){return new e(this.counts.entries())}},{key:"get",value:function(e){var t;return null!==(t=this.counts.get(e))&&void 0!==t?t:0}},{key:"has",value:function(e){return this.counts.has(e)}},{key:"keys",value:function(){return this.counts.keys()}},{key:"entries",value:function(){return this.counts.entries()}},{key:"count",get:function(){return this.counts.size}},{key:"diceCount",get:function(){return Array.from(this.counts.values()).reduce((function(e,t){return e+t}),0)}},{key:"dice",get:function(){return Array.from(this.counts.entries()).map((function(e){var t=(0,o.Z)(e,2),n=t[0],a=t[1];return c.ZP.range(a).map((function(){return n}))})).flat().sort((function(e,t){return h.indexOf(e)-h.indexOf(t)}))}},{key:"replacing",value:function(e,t){return this.copy().replace(e,t)}},{key:"replace",value:function(e,t){return t?this.counts.set(e,t):this.has(e)&&this.counts.delete(e),this}},{key:"limitToCount",value:function(t){if(t<=this.diceCount)return this;var n,i=new e,r=t,u=(0,a.Z)(h);try{for(u.s();!(n=u.n()).done;){var s=n.value,o=Math.min(r,this.get(s));i.counts.set(s,o),r-=o}}catch(c){u.e(c)}finally{u.f()}return i}},{key:"getFaces",value:function(){var e=this;return h.filter((function(t){return e.has(t)}))}},{key:"getOppositeFaces",value:function(){var e=this;return h.filter((function(t){return!e.has(t)}))}},{key:"limitToFaces",value:function(t){var n=this;if(!t.some((function(e){return n.has(e)})))return this;var i,r=new e,u=(0,a.Z)(t);try{for(u.s();!(i=u.n()).done;){var s=i.value;r.replace(s,this.get(s))}}catch(o){u.e(o)}finally{u.f()}return r}}],[{key:"fromDice",value:function(t){return new e(Object.values(c.ZP.groupBy(t)).map((function(e){return[e[0],e.length]})))}},{key:"getNextRolls",value:function(t){var n,i=new Map,r=(0,a.Z)(e.iterateDiceRolls(t));try{for(r.s();!(n=r.n()).done;){var u=n.value;i.has(u.key)||i.set(u.key,{diceRoll:u,count:0}),i.get(u.key).count+=1}}catch(s){r.e(s)}finally{r.f()}return Array.from(i.values())}},{key:"iterateDiceRolls",value:(0,u.Z)().mark((function t(n){var i,r,o,l,v,f,d;return(0,u.Z)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=function(e,t){var n,r,o,c,l,h;return(0,u.Z)().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:n=(0,a.Z)(e),i.prev=1,n.s();case 3:if((r=n.n()).done){i.next=24;break}o=r.value,c=(0,a.Z)(t),i.prev=6,c.s();case 8:if((l=c.n()).done){i.next=14;break}return h=l.value,i.next=12,[].concat((0,s.Z)(o),[h]);case 12:i.next=8;break;case 14:i.next=19;break;case 16:i.prev=16,i.t0=i.catch(6),c.e(i.t0);case 19:return i.prev=19,c.f(),i.finish(19);case 22:i.next=3;break;case 24:i.next=29;break;case 26:i.prev=26,i.t1=i.catch(1),n.e(i.t1);case 29:return i.prev=29,n.f(),i.finish(29);case 32:case"end":return i.stop()}}),i,null,[[1,26,29,32],[6,16,19,22]])},i=(0,u.Z)().mark(r),n){t.next=4;break}return t.abrupt("return");case 4:for(l in o=[[]],c.ZP.range(n))o=r(o,h);v=(0,a.Z)(o),t.prev=7,v.s();case 9:if((f=v.n()).done){t.next=15;break}return d=f.value,t.next=13,e.fromDice(d);case 13:t.next=9;break;case 15:t.next=20;break;case 17:t.prev=17,t.t0=t.catch(7),v.e(t.t0);case 20:return t.prev=20,v.f(),t.finish(20);case 23:case"end":return t.stop()}}),t,null,[[7,17,20,23]])}))}]),e}(),d=function(){function e(t,n){(0,i.Z)(this,e),this.diceCounts=void 0,this.hasWorms=void 0,this.diceCounts=t,this.hasWorms=n}return(0,r.Z)(e,[{key:"total",get:function(){return this.diceCounts.total}},{key:"diceCount",get:function(){return this.diceCounts.diceCount}},{key:"dice",get:function(){return this.diceCounts.dice}},{key:"key",get:function(){return this.diceCounts.key}},{key:"uniqueDice",value:function(){return Array.from(this.diceCounts.keys()).sort()}},{key:"canAdd",value:function(e){return!this.diceCounts.has(e)}},{key:"add",value:function(t,n){if(!this.canAdd(t))throw new Error("Cannot add existing dice to chest");return new e(this.diceCounts.adding(t,n),this.hasWorms||t===l)}},{key:"get",value:function(e){return this.diceCounts.get(e)}},{key:"replacing",value:function(t,n){return e.fromDiceRoll(this.diceCounts.replacing(t,n))}}],[{key:"initial",value:function(){return new e(new f,!1)}},{key:"fromDiceRoll",value:function(t){return new e(new f(t.entries()),t.has(l))}},{key:"fromDice",value:function(e){return this.fromDiceRoll(f.fromDice(e))}}]),e}(),y=function(){function e(t){(0,i.Z)(this,e),this.counts=void 0,this.counts=new Map(t)}return(0,r.Z)(e,[{key:"has",value:function(e){return this.counts.has(e)}},{key:"get",value:function(e){return this.counts.get(e)}},{key:"set",value:function(e,t){return this.counts.set(e,t),this}},{key:"keys",value:function(){return this.counts.keys()}},{key:"entries",value:function(){return this.counts.entries()}},{key:"mergeWith",value:function(e){var t,n=(0,a.Z)(e.entries());try{for(n.s();!(t=n.n()).done;){var i=(0,o.Z)(t.value,2),r=i[0],u=i[1];this.set(r,(this.get(r)||0)+u)}}catch(s){n.e(s)}finally{n.f()}return this}},{key:"add",value:function(e,t){this.set(e,(this.get(e)||0)+t)}},{key:"total",get:function(){return Array.from(this.counts.values()).reduce((function(e,t){return e+t}),0)}},{key:"toFixed",value:function(){return new e(Array.from(this.entries()).map((function(e){var t,n=(0,o.Z)(e,2),a=n[0],i=n[1];if(isNaN(parseFloat(i.toFixed(6))))throw new Error("Value was not a number, it was a ".concat((null===i||void 0===i||null===(t=i.constructor)||void 0===t?void 0:t.name)||i,": ").concat(i));return[a,parseFloat(i.toFixed(6))]})))}},{key:"serialise",value:function(e){var t=Array.from(this.entries());return e.rounded&&(t=t.map((function(e){var t=(0,o.Z)(e,2),n=t[0],a=t[1],i=Math.round(1e3*a);return[n,1e3===i?-1:i]}))),e.compressed&&(t=t.sort((function(e,t){return(0,o.Z)(e,1)[0]-(0,o.Z)(t,1)[0]})).reduce((function(e,t){var n=(0,o.Z)(t,2),a=n[0],i=n[1],r=a,u=a;if(!e.length)return[[r,u,i]];var c=(0,o.Z)(e[e.length-1],3),l=c[0],h=c[1],v=c[2];return h!==u-1||v!==i?[].concat((0,s.Z)(e),[[r,u,i]]):[].concat((0,s.Z)(e.slice(0,e.length-1)),[[l,u,v]])}),[])),t}}],[{key:"deserialise",value:function(t,n){if(n.compressed){var a=t.map((function(e){var t=(0,o.Z)(e,3),n=t[0],a=t[1],i=t[2];return c.ZP.range(n,a+1).map((function(e){return[e,i]}))}));t=a.flat()}return n.rounded&&(t=t.map((function(e){var t=(0,o.Z)(e,2),n=t[0],a=t[1];return[n,(-1===a?1e3:a)/1e3]}))),new e(t)}}]),e}(),p=function(){function e(t,n,a,r){(0,i.Z)(this,e),this.minimumResultOccurrences=void 0,this.exactResultOccurrences=void 0,this.expectedValueOfAtLeast=void 0,this.expectedValue=void 0,this.minimumResultOccurrences=t,this.exactResultOccurrences=n,this.expectedValueOfAtLeast=a,this.expectedValue=r}return(0,r.Z)(e,[{key:"toFixed",value:function(){return new e(this.minimumResultOccurrences.toFixed(),this.exactResultOccurrences.toFixed(),this.expectedValueOfAtLeast.toFixed(),parseFloat(this.expectedValue.toFixed(6)))}},{key:"serialise",value:function(e){var t=this.expectedValue;return e.rounded&&(t=parseInt(t.toFixed(1),10)),{minimumResultOccurrencesEntries:this.minimumResultOccurrences.serialise(e),exactResultOccurrencesEntries:this.exactResultOccurrences.serialise(c.ZP.omit(e,"compressed")),expectedValueOfAtLeastEntries:this.expectedValueOfAtLeast.serialise(e),expectedValue:t}}}],[{key:"combineOptions",value:function(e){var t,n=this.empty(),i=0,r=(0,a.Z)(e);try{for(r.s();!(t=r.n()).done;){var u,s=t.value,c=(0,a.Z)(s.minimumResultOccurrences.entries());try{for(c.s();!(u=c.n()).done;){var l=(0,o.Z)(u.value,2),h=l[0],v=l[1];n.minimumResultOccurrences.set(h,Math.max(n.minimumResultOccurrences.get(h)||0,v))}}catch(R){c.e(R)}finally{c.f()}var f,d=(0,a.Z)(s.exactResultOccurrences.entries());try{for(d.s();!(f=d.n()).done;){var y=(0,o.Z)(f.value,2),p=y[0],m=y[1];n.exactResultOccurrences.set(p,Math.max(n.exactResultOccurrences.get(p)||0,m))}}catch(R){d.e(R)}finally{d.f()}var k,g=(0,a.Z)(s.expectedValueOfAtLeast.entries());try{for(g.s();!(k=g.n()).done;){var C=(0,o.Z)(k.value,2),x=C[0],S=C[1];n.expectedValueOfAtLeast.set(x,Math.max(n.expectedValueOfAtLeast.get(x)||0,S))}}catch(R){g.e(R)}finally{g.f()}i=Math.max(i,s.expectedValue)}}catch(R){r.e(R)}finally{r.f()}return n.expectedValue=i,n}},{key:"combineProbabilities",value:function(e){var t,n=this.empty(),i=0,r=(0,a.Z)(e);try{for(r.s();!(t=r.n()).done;){var u,s=t.value,c=s.evaluation,l=s.ratio,h=(0,a.Z)(c.minimumResultOccurrences.entries());try{for(h.s();!(u=h.n()).done;){var v=(0,o.Z)(u.value,2),f=v[0],d=v[1];n.minimumResultOccurrences.set(f,(n.minimumResultOccurrences.get(f)||0)+d*l)}}catch(Z){h.e(Z)}finally{h.f()}var y,p=(0,a.Z)(c.exactResultOccurrences.entries());try{for(p.s();!(y=p.n()).done;){var m=(0,o.Z)(y.value,2),k=m[0],g=m[1];n.exactResultOccurrences.set(k,(n.exactResultOccurrences.get(k)||0)+g*l)}}catch(Z){p.e(Z)}finally{p.f()}var C,x=(0,a.Z)(c.expectedValueOfAtLeast.entries());try{for(x.s();!(C=x.n()).done;){var S=(0,o.Z)(C.value,2),R=S[0],w=S[1];n.expectedValueOfAtLeast.set(R,(n.expectedValueOfAtLeast.get(R)||0)+w*l)}}catch(Z){x.e(Z)}finally{x.f()}i+=c.expectedValue*l}}catch(Z){r.e(Z)}finally{r.f()}return n.expectedValue=i,n}},{key:"fromTotal",value:function(e){var t,n=this.empty(),i=(0,a.Z)(c.ZP.range(1,e+1));try{for(i.s();!(t=i.n()).done;){var r=t.value;n.minimumResultOccurrences.set(r,1),n.expectedValueOfAtLeast.set(r,e)}}catch(u){i.e(u)}finally{i.f()}return n.exactResultOccurrences.set(e,1),n.expectedValue=e,n}},{key:"empty",value:function(){return new e(new y,new y,new y,0)}},{key:"deserialise",value:function(t,n){return new e(y.deserialise(t.minimumResultOccurrencesEntries,n),y.deserialise(t.exactResultOccurrencesEntries,c.ZP.omit(n,"compressed")),y.deserialise(t.expectedValueOfAtLeastEntries,n),t.expectedValue)}}]),e}(),m=n(1413),k=function(){function e(t,n){(0,i.Z)(this,e),this.state=void 0,this.nextUnrolledStates=void 0,this.evaluation=null,this.state=t,this.nextUnrolledStates=n}return(0,r.Z)(e,[{key:"finished",get:function(){return null!==this.evaluation}},{key:"processAll",value:function(e){for(;this.processOne(e););return this}},{key:"processOne",value:function(e){return!this.finished&&(!!this.nestedProcessOne(e)||(this.evaluation=this.compileEvaluation(),!1))}},{key:"nestedProcessOne",value:function(e){var t=(null!==e&&void 0!==e?e:{}).removeEvaluated,n=void 0!==t&&t;if(this.finished)return!1;var i,r=(0,a.Z)(this.nextUnrolledStates);try{for(r.s();!(i=r.n()).done;){var u=i.value;if(!u.evaluation&&(u.evaluator||(u.evaluator=g.fromUnrolledState(u.unrolledState,!1),!this.useEvaluationCache(u,e))))return u.evaluator.processOne(e),u.evaluator.evaluation&&(u.evaluation=u.evaluator.evaluation,this.setEvaluationCache(u,e),n&&(u.evaluator=null)),!0}}catch(s){r.e(s)}finally{r.f()}return!1}},{key:"useEvaluationCache",value:function(e,t){if(!e.evaluator)return!1;var n=null!==t&&void 0!==t?t:{},a=n.removeEvaluated,i=void 0!==a&&a,r=n.evaluationCache,u=null===r||void 0===r?void 0:r.get(e.evaluator.getCacheKey());return!!u&&(e.evaluation=u,i&&(e.evaluator=null),!0)}},{key:"setEvaluationCache",value:function(e,t){if(e.evaluator&&e.evaluation){var n=(null!==t&&void 0!==t?t:{}).evaluationCache;n&&n.set(e.evaluator.getCacheKey(),e.evaluation)}}},{key:"getCacheKey",value:function(){return["R","t".concat(this.state.unrolledState.chest.total),"c".concat(this.state.unrolledState.chest.uniqueDice().join(",")),"d".concat(this.state.diceRoll.key)].join("").replaceAll(/[[\]]/g,"")}},{key:"compileEvaluation",value:function(){if(this.nextUnrolledStates.some((function(e){return!e.evaluation})))throw new Error("Some part of the evaluation tree is not completed");return this.compilePartialEvaluation({useCached:!1})}},{key:"getCompletionProgress",value:function(){return this.finished?1:this.nextUnrolledStates.reduce((function(e,t){var n,a;return e+(t.evaluation?1:null!==(n=null===(a=t.evaluator)||void 0===a?void 0:a.getCompletionProgress())&&void 0!==n?n:0)}),0)/this.nextUnrolledStates.length}},{key:"compilePartialEvaluation",value:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).useCached,t=void 0===e||e;return this.evaluation&&t?this.evaluation:p.combineOptions(this.nextUnrolledStates.filter((function(e){var t=e.evaluator,n=e.evaluation;return t||n})).map((function(e){var t=e.evaluator,n=e.evaluation;return null!==n&&void 0!==n?n:t.compilePartialEvaluation()})))}}],[{key:"fromRolledState",value:function(t){var n=t.getNextUnrolledStates();return new e(t,n.map((function(e){return{unrolledState:e,evaluator:null,evaluation:null}})))}},{key:"getRemainingDiceCountFromCacheKey",value:function(e){if("R"!==e[0])return null;var t=e.split("d");return(0,o.Z)(t,2)[1].split(",").map((function(e){return parseInt(e,10)})).reduce((function(e,t,n){return n%2===0?e:e+t}),0)}}]),e}(),g=function(){function e(t,n,a){(0,i.Z)(this,e),this.state=void 0,this.nextRolledStates=void 0,this.evaluation=null,this.isRoot=void 0,this.state=t,this.nextRolledStates=n,this.isRoot=a}return(0,r.Z)(e,[{key:"finished",get:function(){return null!==this.evaluation}},{key:"processAll",value:function(e){for(;this.processOne(e););return this}},{key:"processOne",value:function(e){return!this.finished&&(!!this.nestedProcessOne(e)||(this.evaluation||(this.evaluation=this.compileEvaluation(),this.isRoot&&this.setOwnEvaluationCache(e)),!1))}},{key:"nestedProcessOne",value:function(e){var t=(null!==e&&void 0!==e?e:{}).removeEvaluated,n=void 0!==t&&t;if(this.finished)return!1;if(!this.nextRolledStates){if(null!==e&&void 0!==e&&e.evaluationCache){var i=e.evaluationCache.get(this.getCacheKey());if(i)return this.evaluation=i,!1}this.nextRolledStates=this.state.getNextRolledStates().map((function(e){return(0,m.Z)((0,m.Z)({},e),{},{evaluator:null,evaluation:null})}))}var r,u=(0,a.Z)(this.nextRolledStates);try{for(u.s();!(r=u.n()).done;){var s=r.value;if(!s.evaluation&&(s.evaluator||(s.evaluator=k.fromRolledState(s.rolledState),!this.useEvaluationCache(s,e))))return s.evaluator.processOne(e),s.evaluator.evaluation&&(s.evaluation=s.evaluator.evaluation,this.setEvaluationCache(s,e),n&&(s.evaluator=null)),!0}}catch(o){u.e(o)}finally{u.f()}return!1}},{key:"useEvaluationCache",value:function(e,t){if(!e.evaluator)return!1;var n=null!==t&&void 0!==t?t:{},a=n.removeEvaluated,i=void 0!==a&&a,r=n.evaluationCache,u=null===r||void 0===r?void 0:r.get(e.evaluator.getCacheKey());return!!u&&(e.evaluation=u,i&&(e.evaluator=null),!0)}},{key:"setEvaluationCache",value:function(e,t){if(e.evaluator&&e.evaluation){var n=(null!==t&&void 0!==t?t:{}).evaluationCache;n&&n.set(e.evaluator.getCacheKey(),e.evaluation)}}},{key:"setOwnEvaluationCache",value:function(e){if(this.evaluation){var t=(null!==e&&void 0!==e?e:{}).evaluationCache;t&&t.set(this.getCacheKey(),this.evaluation)}}},{key:"getCacheKey",value:function(){return["S","t".concat(this.state.chest.total),"c".concat(this.state.chest.uniqueDice().join(",")),"r".concat(this.state.remainingDiceCount)].join("").replaceAll(/[[\]]/g,"")}},{key:"compileEvaluation",value:function(){if(!this.nextRolledStates||this.nextRolledStates.some((function(e){return!e.evaluation})))throw new Error("Some part of the evaluation tree is not completed");return this.compilePartialEvaluation({useCached:!1})}},{key:"getCompletionProgress",value:function(){return this.finished?1:this.nextRolledStates?this.nextRolledStates.length?this.nextRolledStates.reduce((function(e,t){var n,a;return e+(t.evaluation?1:null!==(n=null===(a=t.evaluator)||void 0===a?void 0:a.getCompletionProgress())&&void 0!==n?n:0)}),0)/this.nextRolledStates.length:1:0}},{key:"compilePartialEvaluation",value:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).useCached,t=void 0===e||e;if(this.evaluation&&t)return this.evaluation;if(!this.nextRolledStates)return p.empty();if(!this.nextRolledStates.length)return p.fromTotal(this.state.total);var n=this.nextRolledStates.filter((function(e){var t=e.evaluator,n=e.evaluation;return t||n})),a=n.reduce((function(e,t){return e+t.count}),0),i=p.combineProbabilities(n.map((function(e){var t=e.evaluator,n=e.evaluation,i=e.count;return{evaluation:null!==n&&void 0!==n?n:t.compilePartialEvaluation(),ratio:i/a}})));return i.exactResultOccurrences.set(this.state.total,1),i}}],[{key:"fromUnrolledState",value:function(t,n){var a=t.getNextRolledStates();return new e(t,a.map((function(e){return(0,m.Z)((0,m.Z)({},e),{},{evaluator:null,evaluation:null})})),n)}},{key:"fromUnrolledStateLazy",value:function(t,n){return new e(t,null,n)}},{key:"getRemainingDiceCountFromCacheKey",value:function(e){if("S"!==e[0])return null;var t=e.split("r"),n=(0,o.Z)(t,2)[1],a=parseInt(n,10);return isNaN(a)?null:a}}]),e}(),C=function(){function e(){(0,i.Z)(this,e)}return(0,r.Z)(e,null,[{key:"evaluatorFromStateLazy",value:function(e,t){switch(e.type){case"unrolled":return g.fromUnrolledStateLazy(e,t);case"rolled":return k.fromRolledState(e);default:throw new Error("Unknown state type")}}},{key:"getStateCacheKey",value:function(e){return this.evaluatorFromStateLazy(e,!0).getCacheKey()}},{key:"processAllFromState",value:function(e,t){return this.evaluatorFromStateLazy(e,!0).processAll(t).evaluation}},{key:"getRemainingDiceCountFromCacheKey",value:function(e){var t;return null!==(t=g.getRemainingDiceCountFromCacheKey(e))&&void 0!==t?t:k.getRemainingDiceCountFromCacheKey(e)}}]),e}(),x=function(){function e(){(0,i.Z)(this,e),this.cache=new Map,this.hitCount=0,this.missCount=0}return(0,r.Z)(e,[{key:"has",value:function(e){return this.cache.has(e)}},{key:"get",value:function(e){return this.cache.has(e)?this.hitCount++:this.missCount++,this.cache.get(e)}},{key:"set",value:function(e,t){this.cache.set(e,t)}},{key:"size",get:function(){return this.cache.size}},{key:"getStats",value:function(){return{hitCount:this.hitCount,missCount:this.missCount,entryCount:this.cache.size}}},{key:"serialise",value:function(e){var t=Array.from(this.cache.entries());return e.sparse&&(t=t.filter((function(e){var t=(0,o.Z)(e,1)[0],n=C.getRemainingDiceCountFromCacheKey(t);return null!==n&&n>4}))),t.map((function(t){var n=(0,o.Z)(t,2),a=n[0],i=n[1].serialise(e);return[a,i.minimumResultOccurrencesEntries,i.exactResultOccurrencesEntries,i.expectedValueOfAtLeastEntries,i.expectedValue]}))}}],[{key:"deserialise",value:function(t,n){var i,r=new e,u=(0,a.Z)(t);try{for(u.s();!(i=u.n()).done;){var s=(0,o.Z)(i.value,5),c=s[0],l=s[1],h=s[2],v=s[3],f=s[4];r.set(c,p.deserialise({minimumResultOccurrencesEntries:l,exactResultOccurrencesEntries:h,expectedValueOfAtLeastEntries:v,expectedValue:f},n))}}catch(d){u.e(d)}finally{u.f()}return r}}]),e}(),S=function(){function e(t,n){(0,i.Z)(this,e),this.type="unrolled",this.chest=void 0,this.remainingDiceCount=void 0,this.chest=t,this.remainingDiceCount=n}return(0,r.Z)(e,[{key:"pickedDice",get:function(){return this.chest.diceCounts.copy()}},{key:"rolledDice",get:function(){return null}},{key:"totalDiceCount",get:function(){return this.chest.diceCount+this.remainingDiceCount}},{key:"selectedDiceCount",get:function(){return this.chest.diceCount}},{key:"total",get:function(){return this.chest.hasWorms?this.chest.total:0}},{key:"getNextRolledStates",value:function(){var e=this;return f.getNextRolls(this.remainingDiceCount).map((function(t){var n=t.diceRoll,a=t.count;return{rolledState:e.withRoll(n),count:a}}))}},{key:"withRoll",value:function(e){return new R(this,e)}},{key:"canAdd",value:function(e){return this.chest.canAdd(e)}},{key:"add",value:function(t,n){return new e(this.chest.add(t,n),this.remainingDiceCount-n)}},{key:"finished",value:function(){return new e(this.chest,0)}},{key:"serialise",value:function(){return{chestDice:this.chest.dice,remainingDiceCount:this.remainingDiceCount}}}],[{key:"initial",value:function(){return new e(d.initial(),8)}},{key:"empty",value:function(){return new e(d.initial(),0)}},{key:"fromDice",value:function(t,n){return new e(d.fromDice(t),n)}},{key:"deserialise",value:function(t){return e.fromDice(t.chestDice,t.remainingDiceCount)}}]),e}(),R=function(){function e(t,n){(0,i.Z)(this,e),this.type="rolled",this.unrolledState=void 0,this.diceRoll=void 0,this.unrolledState=t,this.diceRoll=n}return(0,r.Z)(e,[{key:"pickedDice",get:function(){return this.unrolledState.pickedDice}},{key:"rolledDice",get:function(){return this.diceRoll}},{key:"totalDiceCount",get:function(){return this.unrolledState.totalDiceCount}},{key:"selectedDiceCount",get:function(){return this.unrolledState.selectedDiceCount+this.diceRoll.diceCount}},{key:"remainingDiceCount",get:function(){return this.totalDiceCount-this.selectedDiceCount}},{key:"total",get:function(){return this.unrolledState.total}},{key:"getNextUnrolledStates",value:function(){return this.getNextUnrolledStatesAndPickedRolls().map((function(e){return e.state}))}},{key:"getNextUnrolledStatesAndPickedRolls",value:function(){var e=this,t=Array.from(this.diceRoll.entries()).filter((function(t){var n=(0,o.Z)(t,1)[0];return e.unrolledState.canAdd(n)})).map((function(t){var n=(0,o.Z)(t,2),a=n[0],i=n[1];return{state:e.unrolledState.add(a,i),pickedRoll:a,pickedCount:i}}));return t.length?t:[{state:this.unrolledState.finished(),pickedRoll:null,pickedCount:null}]}},{key:"pick",value:function(e){if(!this.diceRoll.has(e))throw new Error("Face was not rolled");return this.unrolledState.add(e,this.diceRoll.get(e))}},{key:"serialise",value:function(){return{chestDice:this.unrolledState.chest.dice,rolledDice:this.rolledDice.dice}}}],[{key:"fromDice",value:function(t,n){return new e(S.fromDice(t,n.length),f.fromDice(n))}},{key:"deserialise",value:function(t){return e.fromDice(t.chestDice,t.rolledDice)}}]),e}(),w=n(5861),Z=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;(0,i.Z)(this,e),this.evaluationCacheUrlMap=new Map([[5,"evaluation-cache-5-dice.json"],[6,"evaluation-cache-6-dice.json"],[7,"evaluation-cache-7-dice.json"],[8,"evaluation-cache-8-dice.json"]]),this.hasFetchedEvaluationCacheMap=new Map,this.evaluationCacheMap=new Map,this.onCacheFetchingProgress=void 0,this.onCacheFetchingProgress=null!==t&&void 0!==t?t:null}return(0,r.Z)(e,[{key:"get",value:function(){var e=(0,w.Z)((0,u.Z)().mark((function e(t){var n,a;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.shouldFetchEvaluationCache(t)){e.next=27;break}return e.t0=this.evaluationCacheMap,e.t1=t,e.next=5,this.fetchEvaluationCache(t);case 5:if(e.t4=a=e.sent,e.t3=null!==e.t4,!e.t3){e.next=9;break}e.t3=void 0!==a;case 9:if(!e.t3){e.next=13;break}e.t5=a,e.next=14;break;case 13:e.t5=this.evaluationCacheMap.get(t);case 14:if(e.t6=n=e.t5,e.t2=null!==e.t6,!e.t2){e.next=18;break}e.t2=void 0!==n;case 18:if(!e.t2){e.next=22;break}e.t7=n,e.next=23;break;case 22:e.t7=new x;case 23:e.t8=e.t7,e.t0.set.call(e.t0,e.t1,e.t8),e.next=28;break;case 27:this.shouldSetEmptyEvaluationCache(t)&&this.evaluationCacheMap.set(t,new x);case 28:return e.abrupt("return",this.evaluationCacheMap.get(t));case 29:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getSync",value:function(e,t){var n=this;return this.shouldFetchEvaluationCache(e)&&(0,w.Z)((0,u.Z)().mark((function a(){return(0,u.Z)().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=t,a.next=3,n.get(e);case 3:a.t1=a.sent,(0,a.t0)(a.t1);case 5:case"end":return a.stop()}}),a)})))(),this.shouldSetEmptyEvaluationCache(e)&&this.evaluationCacheMap.set(e,new x),this.evaluationCacheMap.get(e)}},{key:"shouldFetchEvaluationCache",value:function(e){var t,n;return!(null!==(t=this.evaluationCacheMap.get(e))&&void 0!==t&&t.size)&&this.evaluationCacheUrlMap.has(e)&&!(null!==(n=this.hasFetchedEvaluationCacheMap.get(e))&&void 0!==n&&n)}},{key:"shouldSetEmptyEvaluationCache",value:function(e){return!this.evaluationCacheMap.has(e)}},{key:"fetchEvaluationCache",value:function(){var e=(0,w.Z)((0,u.Z)().mark((function e(t){var n,a,i,r,s,o;return(0,u.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.evaluationCacheUrlMap.get(t)){e.next=3;break}return e.abrupt("return",null);case 3:return e.next=5,fetch("".concat("/probable-worms","/").concat(i));case 5:return r=e.sent,null===(n=this.onCacheFetchingProgress)||void 0===n||n.call(this,t,"fetching"),e.prev=7,e.t0=x,e.t1=JSON,e.next=12,r.text();case 12:e.t2=e.sent,e.t3=e.t1.parse.call(e.t1,e.t2),e.t4={rounded:!0,compressed:!0,sparse:!0},s=e.t0.deserialise.call(e.t0,e.t3,e.t4),e.next=23;break;case 18:return e.prev=18,e.t5=e.catch(7),null===(o=this.onCacheFetchingProgress)||void 0===o||o.call(this,t,"failure"),console.error("File was not a valid cache file"),e.abrupt("return",null);case 23:return this.hasFetchedEvaluationCacheMap.set(t,!0),null===(a=this.onCacheFetchingProgress)||void 0===a||a.call(this,t,"success"),e.abrupt("return",s);case 26:case"end":return e.stop()}}),e,this,[[7,18]])})));return function(t){return e.apply(this,arguments)}}()},{key:"clear",value:function(e){return this.evaluationCacheMap.set(e,new x),this.evaluationCacheMap.get(e)}},{key:"set",value:function(e,t){this.evaluationCacheMap.set(e,t)}}]),e}(),E=function(){function e(t){var n=this;(0,i.Z)(this,e),this.instancesById=new Map,this.worker=void 0,this.onCacheFetchingProgress=function(e,t){var i,r=Array.from(n.instancesById.values()).filter((function(t){return t.stateEvaluator.state.totalDiceCount===e})),u=(0,a.Z)(r);try{for(u.s();!(i=u.n()).done;){var s=i.value;n.postMessage({type:"cache-fetching-progress",id:s.id,diceCount:e,status:t})}}catch(o){u.e(o)}finally{u.f()}},this.evaluationCacheCache=new Z(this.onCacheFetchingProgress),this.onMessage=function(e){var t=e.data;switch(t.type){case"set-state":switch(t.stateType){case"unrolled":n.onSetUnrolledState(t.id,S.deserialise(t.state));break;case"rolled":n.onSetRolledState(t.id,R.deserialise(t.state));break;default:throw new Error("Unknown state type")}break;case"step":n.onStep(t.id);break;case"start":n.onStart(t.id);break;case"stop":n.onStop(t.id);break;case"remove":n.onRemove(t.id);break;case"download-evaluation-cache":n.onDownloadEvaluationCache(t.id);break;case"load-evaluation-cache":n.onLoadEvaluationCache(t.id,t.jsonSerialised);break;case"clear-evaluation-cache":n.onClearEvaluationCache(t.id)}},this.worker=t,this.worker.onmessage=this.onMessage}return(0,r.Z)(e,[{key:"postMessage",value:function(e){this.worker.postMessage(e)}},{key:"postResult",value:function(e){var t=this;if(this.instancesById.has(e)){var n=this.instancesById.get(e),a=n.stateEvaluator,i=n.searching,r=n.evaluationCache,u=a.getCompletionProgress(),s=a.compilePartialEvaluation().serialise({});this.postMessage({type:"result",id:e,progress:u,searching:i,searchFinished:1===u,evaluation:s,preRollEvaluation:"unrolled"===n.stateEvaluator.state.type?s:this.getEvaluation(n,n.stateEvaluator.state.unrolledState).serialise({}),dicePickEvaluations:"unrolled"===a.state.type?null:a.state.getNextUnrolledStatesAndPickedRolls().filter((function(e){return null!==e.pickedRoll})).map((function(e){var a=e.state;return{pickedRoll:e.pickedRoll,pickedCount:e.pickedCount,evaluation:t.getEvaluation(n,a).serialise({})}})),cacheStats:r.getStats()})}}},{key:"onSetUnrolledState",value:function(e,t){this.setStateEvaluator(e,g.fromUnrolledStateLazy(t,!0))}},{key:"onSetRolledState",value:function(e,t){this.setStateEvaluator(e,k.fromRolledState(t))}},{key:"setStateEvaluator",value:function(e,t){var n=this;this.onStop(e);var a={id:e,stateEvaluator:t,searching:!1,evaluationCache:this.evaluationCacheCache.getSync(t.state.totalDiceCount,(function(t){var a=n.instancesById.get(e);a&&n.setEvaluationCache(a,t)}))};this.instancesById.set(e,a),this.setEvaluationCache(a,a.evaluationCache),!a.stateEvaluator.finished&&!a.searching&&a.stateEvaluator.state.remainingDiceCount<=4&&this.onStart(a.id)}},{key:"getEvaluation",value:function(e,t){var n,a=C.getStateCacheKey(t);return!e.evaluationCache.has(a)&&t.remainingDiceCount<=4&&C.processAllFromState(t,{evaluationCache:e.evaluationCache}),null!==(n=e.evaluationCache.get(a))&&void 0!==n?n:p.empty()}},{key:"onStep",value:function(e){if(this.instancesById.has(e)){var t=this.instancesById.get(e),n=t.stateEvaluator,a=t.evaluationCache;n.processOne({removeEvaluated:!0,evaluationCache:a}),this.postResult(e)}}},{key:"onStart",value:function(e){this.onStop(e);var t=this.makeSearch(e);t&&self.setTimeout(t,0)}},{key:"onDownloadEvaluationCache",value:function(e){if(this.instancesById.has(e)){var t=this.instancesById.get(e).evaluationCache,n=(new TextEncoder).encode(JSON.stringify(t.serialise({rounded:!0,compressed:!0,sparse:!0}))),a=new Blob([n],{type:"application/json;charset=utf-8"}),i=URL.createObjectURL(a);self.postMessage({type:"evaluation-cache-link",id:e,link:i})}}},{key:"onLoadEvaluationCache",value:function(e,t){if(this.instancesById.has(e)){var n,a=this.instancesById.get(e);try{n=x.deserialise(JSON.parse(t),{rounded:!0,compressed:!0,sparse:!0})}catch(i){return void console.error("File was not a valid cache file")}this.setEvaluationCache(a,n)}}},{key:"setEvaluationCache",value:function(e,t){this.evaluationCacheCache.set(e.stateEvaluator.state.totalDiceCount,t),e.evaluationCache=t;var n=e.stateEvaluator,a=n.getCacheKey();!n.finished&&e.evaluationCache.has(a)&&(n.evaluation=e.evaluationCache.get(a),e.searching=!0),this.postResult(e.id)}},{key:"onClearEvaluationCache",value:function(e){if(this.instancesById.has(e)){var t=this.instancesById.get(e);t.evaluationCache=this.evaluationCacheCache.clear(t.stateEvaluator.state.totalDiceCount),this.postResult(e)}}},{key:"makeSearch",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;if(!this.instancesById.has(e))return null;var a=this.instancesById.get(e);a.searching=!0;return function i(){for(var r=new Date;a.searching&&!a.stateEvaluator.finished;){if(a.stateEvaluator.processOne({removeEvaluated:!0,evaluationCache:a.evaluationCache}),(new Date).valueOf()-r.valueOf()>=n){self.setTimeout(i,0);break}}t.postResult(e)}}},{key:"onStop",value:function(e){this.instancesById.has(e)&&(this.instancesById.get(e).searching=!1,this.postResult(e))}},{key:"onRemove",value:function(e){this.instancesById.has(e)&&(this.instancesById.get(e).searching=!1,this.postResult(e),this.instancesById.delete(e))}}],[{key:"default",value:function(){return new e(self)}}]),e}();E.default()}},t={};function n(a){var i=t[a];if(void 0!==i)return i.exports;var r=t[a]={exports:{}};return e[a](r,r.exports,n),r.exports}n.m=e,n.x=function(){var e=n.O(void 0,[871],(function(){return n(3956)}));return e=n.O(e)},function(){var e=[];n.O=function(t,a,i,r){if(!a){var u=1/0;for(l=0;l<e.length;l++){a=e[l][0],i=e[l][1],r=e[l][2];for(var s=!0,o=0;o<a.length;o++)(!1&r||u>=r)&&Object.keys(n.O).every((function(e){return n.O[e](a[o])}))?a.splice(o--,1):(s=!1,r<u&&(u=r));if(s){e.splice(l--,1);var c=i();void 0!==c&&(t=c)}}return t}r=r||0;for(var l=e.length;l>0&&e[l-1][2]>r;l--)e[l]=e[l-1];e[l]=[a,i,r]}}(),n.d=function(e,t){for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.f={},n.e=function(e){return Promise.all(Object.keys(n.f).reduce((function(t,a){return n.f[a](e,t),t}),[]))},n.u=function(e){return"static/js/"+e+".6b4d62fe.chunk.js"},n.miniCssF=function(e){},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.p="/probable-worms/",function(){var e={956:1};n.f.i=function(t,a){e[t]||importScripts(n.p+n.u(t))};var t=self.webpackChunkprobable_worms=self.webpackChunkprobable_worms||[],a=t.push.bind(t);t.push=function(t){var i=t[0],r=t[1],u=t[2];for(var s in r)n.o(r,s)&&(n.m[s]=r[s]);for(u&&u(n);i.length;)e[i.pop()]=1;a(t)}}(),function(){var e=n.x;n.x=function(){return n.e(871).then(e)}}();n.x()}();
//# sourceMappingURL=956.a7bbe6a6.chunk.js.map